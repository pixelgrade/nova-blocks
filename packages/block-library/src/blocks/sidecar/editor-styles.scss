$grid-selector: '.block-editor-inner-blocks > .block-editor-block-list__layout';
$align-selectors: '[data-align="full"], [data-align="wide"], [data-novablocks-alignment="pull-left"], [data-novablocks-alignment="pull-right"]';

@import 'scss/mixins';

:root {
  --inspector-controls-width: 280px;
}

.is-sidebar-opened {
  
  .novablocks-sidecar {
    --full-pull-value: calc(var(--novablocks-final-excess-width) * 0.5 - var(--inspector-controls-width) * 0.5);
  }
}

.block-editor-block-list__layout.is-root-container {
  @include layout-grid;
  @include layout-settings;
  
  display: block !important;
  
  @import 'scss/block-limits.scss';
  
  grid-auto-flow: row dense;
  
  .wp-block[data-align='wide'] {
    max-width: 100% !important;
  }
  
  >  * {
    &:not([data-type="novablocks/sidecar"]),
    &:not([data-align="full"]),
    &:not([data-align="wide"]) {
      max-width: calc(var(--novablocks-final-content-width) + var(--wd)) !important;
    }
  }
  
  [data-type="novablocks/sidecar-area"] {
    width: 100% !important;
  }
  
  > [data-align="full"][class]  {
    max-width: 100vw !important;
    margin-left: auto;
    margin-right: auto;
    
      //max-width: 100% !important;
    }
  
  > [data-align="wide"][class] {
    max-width: calc(var(--novablocks-final-content-width) + var(--wd) * 2 + var(--grid-gap) * 4) !important;
    margin-left: auto;
    margin-right: auto;
  }
  
  > [data-align="left"] {
    --pull-left-value: calc((max(var(--wd), var(--minimum-sidebar-left-width))) * 0.5 + var(--grid-gap));
  }
  
  > [data-align="right"]  {
    --pull-right-value: calc((max(var(--wd), var(--minimum-sidebar-left-width))) * 0.5 + var(--grid-gap));
  }
  
  > [data-align="left"] > figure  {
    margin-left: calc(-1 * var(--pull-left-value, 0px));
  }
  
  > [data-align="right"] > figure  {
    margin-right: calc(-1 * var(--pull-right-value, 0px));
  }
  
  // Markup is different compared to front-end,
  // and because of that, the last block is
  // currently not sticky inside the editor.
  .last-block-is-sticky > :last-child {
    z-index: 1;
  }
}

.novablocks-sidecar > #{$grid-selector} {
  
  @include layout-grid;
  
  > * {
    // Temporary
    // @todo: Remove this
    margin-top: 0 !important;
    max-width: 100% !important;
  }
  
  [class*='__inner-container']:not(.novablocks-card__layout-content) {
    padding-left: 0;
    padding-right: 0;
  }
}

// The default layout is Content Left with Sidebar Right.
// Content will always be the first child of layout block,
// and it will change it's grid position, according
// to sidebar position (left or right).
.novablocks-sidecar {
  
    &,
    #{$align-selectors} {
      --block-content-start: var(--block-limit-left);
      --block-content-end: ce;
    }
  
  > #{$grid-selector} {
  
    > * {
      grid-row: 1;
    }
  
    @include layout-grid;
  
    // Content
    > :first-child {
      
      grid-column: var(--block-content-start)/var(--block-content-end);
    
      > .wp-block-novablocks-sidecar-area {
      
        > #{$grid-selector} {
        
          //@include layout-grid;
        
          > * {
            grid-column: var(--block-content-start)/var(--block-content-end);
          }
        
          [data-type='novablocks/sidecar'] {
            grid-column: var(--all-columns);
          }
        }
      }
    }
  
    // Sidebar
    > :last-child {
      grid-column: ge/var(--block-limit-right);
    }
  }
  
  &--sidebar-left {
  
    &,
    #{$align-selectors} {
      --block-content-start: cs;
      --block-content-end: var(--block-limit-right);
    }
  
    > #{$grid-selector} {
  
      > :first-child {
        grid-column: var(--block-content-start)/var(--block-content-end);
      }
  
      // Sidebar
      > :last-child {
        grid-column: var(--block-limit-left)/gs;
        z-index: 2;
      }
    }
  }
  
  .novablocks-content,
  &--sidebar-left,
  &--sidebar-right,
  &--complex {
    display: block;
  }
}

// Block Grid
.novablocks-sidecar {
  
  &--complex {
    
    &[class] {
      
      #{$align-selectors} {
        --block-content-start: cs;
        --block-content-end: ce;
      }
    }
    
    > #{$grid-selector} {
      
      > * {
        grid-row: 1;
      }
      
      // Sidebar Left
      >:first-child {
        
        --block-content-start: cs;
        --block-content-end: ce;
  
        > .novablocks-content {
    
          > #{$grid-selector} {
      
            > * {
              grid-column: var(--block-content-start)/var(--block-content-end);
            }
          }
        }
      }
      
      // Content
      >:not(:first-child):not(:last-child) {
  
        grid-column: var(--block-limit-left)/gs;
      }
      
      // Sidebar Right
      >:last-child {
        grid-column: ge/var(--block-limit-right);
        
        // We need this z-index, to make sure that
        // we can select blocks that are inside the sidebar.
        z-index: 2;
      }
    }
  }
}

.novablocks-sidecar--sidebar-right .novablocks-sidecar--sidebar-left,
.novablocks-sidecar--sidebar-left .novablocks-sidecar--sidebar-right {
  
  #{$align-selectors} {
    --block-content-start: cs;
    --block-content-end: ce;
  }
}

.novablocks-sidecar--sidebar-right .novablocks-sidecar--sidebar-right {
  --block-content-start: var(--block-limit-left);
  --block-content-end: ce;
}

// Show Sidecar inner areas outline
// when the main block is selected
[data-type='novablocks/sidecar'] {
  &.is-selected,
  &.is-highlighted,
  &.is-multi-selected,
  &.has-child-selected {
    .novablocks-sidebar,
    .novablocks-content {
      > #{$grid-selector} {
        @include block-outline;
      }
    }
  }
}

// Overwrite default focus block style
// and apply them around grid columns.
[data-type='novablocks/sidecar-area'] {
  &.is-selected,
  &.is-highlighted,
  &.is-multi-selected,
  &.has-child-selected {
    
    &:after {
      box-shadow: none !important;
    }
    
    &.is-highlighted {
      
      .novablocks-content,
      .novablocks-sidebar {
    
        > #{$grid-selector} {
      
          &:after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            grid-column: var(--block-content-start)/var(--block-content-end);
            box-shadow: 0 0 0 2px #007cba;
            box-shadow: 0 0 0 var(--wp-admin-border-width-focus) var(--wp-admin-theme-color);
            border-radius: 1px;
            outline: 2px solid transparent;
          }
        }
      }
    }
    
  }
}

.novablocks-content {
  
  .wp-block {
    margin-left: 0;
    margin-right: 0;
  }
  
  #{$grid-selector} {
  
    > .alignfull,
    [data-align="full"] {
      margin-left: calc(-1 * Max(0px, var(--pull-left-value)));
      margin-right: calc(-1 * Max(0px, var(--pull-right-value)));
    }
  
    > .alignwide,
    [data-align="wide"] {
      margin-right: calc(-1 * Max(0px, var(--pull-right-value)));
      margin-left: calc(-1 * Max(0px, var(--pull-left-value)));
    }
  
    // Pull Left and Right value are very specific
    // and to reach that level of specificity
    // a lot of classes will be needed. Because of that,
    // we have choose to use !important in this case.
    // Just because, whenever this class exist,
    // we want this CSS to be applied.
    .stop-right,
    .stop-right *{
      --pull-right-value: 0px !important;
    }
  
    .stop-left,
    .stop-left *{
      --pull-left-value: 0px !important;
    }
  }
  
  [data-type="novablocks/sidecar"] {
    
    &,
    > .wp-block {
      margin: 0 !important;
    }
  }
  
}

[data-type='novablocks/sidecar'] {
  
  [data-align='full'] {
    --block-content-start: ws;
  }
  
  [data-type='novablocks/sidecar'] {
  
    .novablocks-content {
      [data-align='full'],
      [data-align='wide'] {
        --block-content-start: cs;
        --block-content-end: ce;
      }
    }
  }
  
  .novablocks-sidecar--sidebar-left {
  
    [data-align='full'] {
      --block-content-start: cs;
      --block-content-end: we;
    }
  }
}

.novablocks-content > #{$grid-selector} > * {
  z-index: 1;
}


// Block Alignments
.novablocks-sidecar--sidebar-right {

  .novablocks-content {

    .alignfull,
    [data-align='full'] {
      --pull-left-value: var(--full-pull-value);
      --pull-right-value: 0px;
    }

    .alignwide,
    [data-align='wide']{
      --pull-left-value: 0px;
      --pull-right-value: 0px;
    }

    [data-novablocks-alignment="pull-left"] {
      --minimum-sidebar-width: var(--minimum-sidebar-left-width);
      @include pull-align-item(left, false, false);
    }
  
    [data-novablocks-alignment="pull-right"] {
      --minimum-sidebar-width: var(--minimum-sidebar-right-width);
      @include pull-align-item(right, false, false);
    }
  
    [data-align="left"][class] {
      --pull-left-value: 0px;
    }
  
    [data-align="right"][class] {
      --pull-right-value: 0px;
    }
  }
}

.novablocks-sidecar--sidebar-left {
  
  .novablocks-content {
    
    .alignfull,
    [data-align='full'] {
      --pull-left-value: 0px;
      --pull-right-value:var(--full-pull-value);
    }
    
    .alignwide,
    [data-align='wide']{
      --pull-left-value: 0px;
      --pull-right-value: 0px;
    }
    
    [data-novablocks-alignment="pull-left"] {
      --minimum-sidebar-width: var(--minimum-sidebar-left-width);
      @include pull-align-item(left, false, false);
    }
    
    [data-novablocks-alignment="pull-right"] {
      --minimum-sidebar-width: var(--minimum-sidebar-right-width);
      @include pull-align-item(right, false, false);
    }
  
    [data-align="left"][class] {
      --pull-left-value: 0px;
    }
  
    [data-align="right"][class] {
      --pull-right-value: 0px;
    }
  }
}

.novablocks-sidecar--complex {
  
  .novablocks-content {
    
    .alignfull,
    [data-align='full'] {
      --pull-left-value: 0px;
      --pull-right-value: 0px;
    }
  
    .alignwide,
    [data-align='wide']{
      --pull-left-value: 0px;
      --pull-right-value: 0px;
    }
  
    [data-novablocks-alignment="pull-left"] {
      --minimum-sidebar-width: var(--minimum-sidebar-left-width);
      @include pull-align-item(left, false, false);
    }
  
    [data-novablocks-alignment="pull-right"] {
      --minimum-sidebar-width: var(--minimum-sidebar-right-width);
      @include pull-align-item(right, false, false);
    }
    
  }
}

.novablocks-sidecar {
  
  &:not(.novablocks-sidecar--sidebar-left) {
    
    &.novablocks-sidebar--medium {
      
      > #{$grid-selector} {
        --sidebar-right-size-modifier: 1.3;
      }
    }
  }
}

.novablocks-sidecar.novablocks-sidecar--sidebar-left {
  
  &.novablocks-sidebar--medium {
    
    > #{$grid-selector} {
      --sidebar-left-size-modifier: 1.3;
    }
  }
}

@include above(lap) {
  .novablocks-content[class] {
    
    [data-align="left"] {
      --pull-left-value: calc((max(var(--wd), var(--minimum-sidebar-left-width))) * 0.5 + var(--grid-gap));
    }
  
    [data-align="right"] {
      --pull-right-value: calc((max(var(--wd), var(--minimum-sidebar-left-width))) * 0.5 + var(--grid-gap));
    }
  
    [data-align="left"] {
      margin-left: calc(-1 * var(--pull-left-value, 0px));
    }
  
    [data-align="right"] {
      margin-right: calc(-1 * var(--pull-right-value, 0px));
    }
  }
}

[data-type="novablocks/sidecar-area"] {
  
  [data-type="novablocks/posts-collection"] {
  
    &,
    [data-align="full"] {
      margin-left: 0 !important;
      margin-right: 0 !important;
    }
  }
}
